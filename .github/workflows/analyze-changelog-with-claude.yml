name: Analyze Massive Changes with Claude

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze:
    if: |
      contains(github.event.issue.labels.*.name, 'massive-api-update') &&
      contains(github.event.comment.body, '/analyze-changes')
    runs-on: ubuntu-latest

    steps:
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Gather codebase context
        id: context
        run: |
          # Collect all stream file paths and their class/schema definitions
          echo "## Stream Files in tap_massive/streams/" > codebase-context.md
          echo "" >> codebase-context.md

          for f in tap_massive/streams/*.py; do
            [ "$f" = "tap_massive/streams/__init__.py" ] && continue
            echo "### $f" >> codebase-context.md
            echo '```python' >> codebase-context.md
            cat "$f" >> codebase-context.md
            echo '```' >> codebase-context.md
            echo "" >> codebase-context.md
          done

      - name: Extract changelog from issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body || '';
            fs.writeFileSync('changelog-entries.txt', body);

      - name: Call Claude API for analysis
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          CHANGELOG=$(cat changelog-entries.txt)
          CODEBASE=$(cat codebase-context.md)

          # Build the prompt
          cat > prompt.txt << 'PROMPT_END'
          You are updating a Singer tap for the Massive API (https://massive.com).

          CRITICAL RULES:
          - Field names must be snake_case (the SDK auto-converts from camelCase)
          - Use singer_sdk typing: th.StringType, th.IntegerType, th.BooleanType, th.NumberType, th.DateType, th.DateTimeType, th.ArrayType, th.ObjectType
          - Only add new fields to existing schemas. Do NOT remove fields, rename classes, or change endpoints unless the changelog explicitly says to.
          - All streams already have additionalProperties: True, so missing fields won't cause errors. But explicit schema fields are preferred for type validation.
          - Massive API endpoints are documented at: https://massive.com/docs

          Based on the changelog entries below, identify which stream schemas need new fields added.

          For each file that needs changes, output the COMPLETE updated file contents. Do not output partial files or diffs.

          Output your response as a JSON object with this exact structure:
          {
            "analysis": "Human-readable summary of changes needed",
            "no_changes_needed": false,
            "files": [
              {
                "path": "tap_massive/streams/labor_market_streams.py",
                "content": "...full file content...",
                "description": "Added new_field field to SomeStream"
              }
            ]
          }

          If no code changes are needed (e.g., all changes are internal/non-breaking), set "no_changes_needed": true and "files": [].

          IMPORTANT: Output ONLY the JSON object. No markdown fences, no commentary before or after.
          PROMPT_END

          # Use jq to safely build the API request JSON
          jq -n \
            --arg prompt "$(cat prompt.txt)" \
            --arg changelog "$CHANGELOG" \
            --arg codebase "$CODEBASE" \
            '{
              model: "claude-sonnet-4-5-20250929",
              max_tokens: 16000,
              messages: [{
                role: "user",
                content: ($prompt + "\n\n## CHANGELOG ENTRIES\n\n" + $changelog + "\n\n## CURRENT CODEBASE\n\n" + $codebase)
              }]
            }' > api-request.json

          # Call Claude API
          HTTP_CODE=$(curl -s -o claude-response.json -w "%{http_code}" \
            https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @api-request.json)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Claude API returned HTTP $HTTP_CODE"
            cat claude-response.json
            exit 1
          fi

          # Extract the text content from Claude's response
          jq -r '.content[0].text' claude-response.json > claude-analysis-raw.txt

          # Strip markdown code fences if Claude wrapped the JSON
          sed -n '/^{/,/^}/p' claude-analysis-raw.txt > claude-analysis.json

          # Validate it's parseable JSON
          if ! jq empty claude-analysis.json 2>/dev/null; then
            echo "::error::Claude did not return valid JSON"
            echo "Raw response:"
            cat claude-analysis-raw.txt
            echo "fallback=true" >> "$GITHUB_OUTPUT"
          else
            NO_CHANGES=$(jq -r '.no_changes_needed // false' claude-analysis.json)
            echo "no_changes=$NO_CHANGES" >> "$GITHUB_OUTPUT"
            echo "fallback=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post fallback comment if JSON parsing failed
        if: steps.claude.outputs.fallback == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const raw = fs.readFileSync('claude-analysis-raw.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `## Claude Analysis (manual review needed)\n\nClaude's response couldn't be auto-applied. Here's the raw analysis:\n\n${raw}`
            });

      - name: Apply file changes and create PR
        if: steps.claude.outputs.fallback == 'false' && steps.claude.outputs.no_changes != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('claude-analysis.json', 'utf8'));

            // Create branch
            const branchName = `massive-api-update-${new Date().toISOString().split('T')[0].replace(/-/g, '')}`;
            const mainRef = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: mainRef.data.object.sha
            });

            // Apply each file change as a commit
            for (const file of analysis.files) {
              let fileSha;
              try {
                const { data: existing } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: file.path,
                  ref: branchName
                });
                fileSha = existing.sha;
              } catch (e) {
                fileSha = undefined;
              }

              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: file.path,
                message: `chore: ${file.description}`,
                content: Buffer.from(file.content).toString('base64'),
                branch: branchName,
                ...(fileSha ? { sha: fileSha } : {})
              });
            }

            // Build PR body
            const fileList = analysis.files
              .map(f => `- \`${f.path}\`: ${f.description}`)
              .join('\n');

            const prBody = [
              `## Massive API Schema Updates`,
              ``,
              analysis.analysis,
              ``,
              `### Files Changed`,
              ``,
              fileList,
              ``,
              `### Testing Checklist`,
              ``,
              `- [ ] \`./lint.sh\` passes`,
              `- [ ] \`uv run pytest\` passes`,
              `- [ ] Test affected streams: \`meltano run tap-massive target-jsonl\``,
              `- [ ] Review schema changes match Massive API docs`,
              ``,
              `---`,
              `Source: #${context.payload.issue.number}`,
              `Generated by Claude AI`,
            ].join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Massive API] Schema updates â€” ${new Date().toISOString().split('T')[0]}`,
              head: branchName,
              base: 'main',
              body: prBody
            });

            // Comment on the issue with the PR link
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `PR created with schema updates: ${pr.html_url}\n\n**Analysis:**\n${analysis.analysis}`
            });

      - name: Post no-changes comment
        if: steps.claude.outputs.fallback == 'false' && steps.claude.outputs.no_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = JSON.parse(fs.readFileSync('claude-analysis.json', 'utf8'));

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `## No Code Changes Needed\n\n${analysis.analysis}\n\nThe changelog updates don't require schema changes. You can close this issue.`
            });

      - name: React with result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reaction = '${{ job.status }}' === 'success' ? 'rocket' : '-1';
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: reaction
            });
